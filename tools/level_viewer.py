#!/usr/bin/python3

from __future__ import annotations

import logging
import pathlib
import struct
import sys

import tkinter
import tkinter.ttk

from typing import (
    MutableSequence,
    Optional,
    Sequence,
)


def main() -> None:
    logging.basicConfig(
        level=logging.DEBUG,
    )
    app = TkApp()
    for file_name in sys.argv[1:]:
        app.add_file(file_path=pathlib.Path(file_name))
    app.run()


# FIXME: Don't hardcode this! --GM
hi_bytes: Sequence[int] = [
    # fmt: off
    0x00, 0x16, 0x10, 0x10, 0x10, 0x00, 0x00, 0x08, 0x09, 0x0A, 0x05, 0x06, 0x07, 0x03, 0x04, 0x01,
    0x02, 0x10, 0x00, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x0C,
    0x0D, 0x0E, 0x0F, 0x0B, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x10, 0x10, 0x00, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x16, 0x16, 0x12, 0x10, 0x15, 0x00, 0x00, 0x10, 0x16, 0x1E, 0x16,
    0x11, 0x10, 0x00, 0x10, 0x10, 0x1E, 0x1E, 0x1E, 0x10, 0x1E, 0x00, 0x00, 0x16, 0x1E, 0x16, 0x1E,
    0x00, 0x27, 0x1E, 0x00, 0x27, 0x27, 0x27, 0x27, 0x27, 0x16, 0x27, 0x27, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x05, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0x80, 0x90, 0x80, 0x96, 0x90, 0x80, 0x90, 0x80, 0x80, 0x80, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7,
    0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0x00, 0x00, 0x00, 0x00, 0x90, 0x9E, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    # fmt: on
]

# FIXME: Don't hardcode this either! --GM
lo_bytes: Sequence[int] = [
    # fmt: off
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x62, 0x01, 0x01, 0x01, 0x72, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0x70, 0x03, 0x02, 0x03, 0x80, 0x02, 0x03, 0x02, 0x70, 0x03, 0x02, 0x03, 0x80, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x71, 0x03, 0x02, 0x03, 0x81, 0x02, 0x03, 0x02, 0x71, 0x03, 0x02, 0x03, 0x81,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x21,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x21, 0x20, 0x21, 0x30, 0x31, 0x52, 0x53, 0x32, 0x02,
    0x20, 0x21, 0x30, 0x31, 0x52, 0x53, 0x32, 0x02, 0x2D, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x50, 0x51, 0x40, 0x41, 0x03, 0x42, 0x60, 0x61, 0x02, 0x03, 0x02, 0x8B, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x40, 0x41, 0x00, 0x00, 0x50, 0x51, 0x40, 0x41, 0x03, 0x42, 0x60, 0x61,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x41, 0x00, 0x00,
    0x00, 0x12, 0x22, 0x32, 0x12, 0x22, 0x32, 0x02, 0x22, 0x32, 0x02, 0x03, 0x32, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x12, 0x22,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x23, 0x13, 0x00, 0x00,
    0x33, 0x23, 0x13, 0x00, 0x03, 0x33, 0x23, 0x13, 0x02, 0x03, 0x33, 0x23, 0x03, 0x02, 0x03, 0x33,
    0x2E, 0x2F, 0x2E, 0x2F, 0x2E, 0x2F, 0x2E, 0x2F, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x0F, 0xF0, 0xF1, 0x1E, 0x1F, 0xE2, 0xF2, 0x2E, 0x2F,
    0x00, 0x00, 0x3B, 0x3C, 0x00, 0x00, 0x4B, 0x4C, 0x00, 0x00, 0x5B, 0x5C, 0x00, 0x00, 0x6B, 0x6C,
    0x3D, 0x3E, 0x3F, 0x00, 0x4D, 0x4E, 0x4F, 0x00, 0x5D, 0x5E, 0x5F, 0x00, 0x6D, 0x6E, 0x6F, 0x00,
    0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x0D, 0x2E, 0x2F, 0x00, 0x0D, 0x2E, 0x2F, 0x00, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x04, 0x06, 0x26, 0x05, 0x14, 0x16, 0x36, 0x15, 0x24, 0x82, 0x00, 0x25, 0x34, 0x00, 0x83, 0x35,
    0x00, 0x04, 0x05, 0x00, 0x00, 0x14, 0x15, 0x00, 0x00, 0x24, 0x25, 0x00, 0x00, 0x34, 0x35, 0x00,
    0x00, 0x00, 0x04, 0x05, 0x00, 0x00, 0x14, 0x15, 0x00, 0x04, 0x24, 0x25, 0x82, 0x34, 0x83, 0x35,
    0x0D, 0x00, 0x0B, 0x0C, 0x0D, 0x00, 0x1B, 0x1C, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x09, 0x0A, 0x17, 0x18, 0x19, 0x1A, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x08, 0x07, 0x08, 0x1D, 0x1D, 0x17, 0x18, 0x19, 0x1A, 0x00, 0x00, 0x00, 0x00,
    0x09, 0x0A, 0x00, 0x00, 0x1D, 0x1D, 0x09, 0x0A, 0x17, 0x18, 0x19, 0x1A, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45, 0x46, 0x45, 0x46, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x46, 0x45, 0x46, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45, 0x46, 0x45, 0x47, 0x00, 0x00, 0x00, 0x00,
    0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x44, 0x45, 0x46, 0x0D, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x45, 0x46, 0x47, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0x08, 0x09, 0x00, 0x17, 0x1D, 0x1D, 0x07, 0x08, 0x1D, 0x1D, 0x17, 0x18, 0x19, 0x18,
    0x08, 0x09, 0x0A, 0x00, 0x19, 0x19, 0x1A, 0x00, 0x09, 0x0A, 0x00, 0x00, 0x19, 0x1A, 0x00, 0x00,
    0x00, 0x00, 0x0B, 0x0C, 0x00, 0x00, 0x1B, 0x1C, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x0E, 0x0F, 0x00, 0x0D, 0x1E, 0x1F, 0x00,
    0x00, 0x00, 0x7B, 0x7C, 0x00, 0x00, 0x00, 0x8C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7D, 0x7E, 0x00, 0x00, 0x8D, 0x8E, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00,
    0x00, 0x04, 0x7B, 0x7C, 0x00, 0x14, 0x15, 0x8C, 0x00, 0x24, 0x25, 0x00, 0x00, 0x34, 0x35, 0x00,
    0x28, 0x54, 0x55, 0x27, 0x38, 0x64, 0x65, 0x37, 0x00, 0x56, 0x57, 0x00, 0x00, 0x66, 0x67, 0x00,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x90, 0x91, 0x90, 0x91, 0xA0, 0xA1, 0xA0, 0xA1,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x15, 0x00, 0x00, 0x82, 0x25, 0x82, 0x83,
    0xB4, 0xB5, 0xB4, 0xB5, 0xB2, 0xB3, 0xB2, 0xB3, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x92, 0x93, 0x00, 0x00, 0xA2, 0xA3, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9C, 0x9D, 0x9E, 0x9F, 0xAC, 0xAD, 0xAE, 0xAF,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xBC, 0xBD, 0xBE, 0xBF, 0xCC, 0xCD, 0xCE, 0xCF,
    0x00, 0x00, 0x00, 0x00, 0x9C, 0x9D, 0x9E, 0x9F, 0x98, 0x99, 0x9A, 0x9B, 0x03, 0x02, 0x68, 0x69,
    0x00, 0x00, 0x00, 0x00, 0xBC, 0xBD, 0xBE, 0xBF, 0xA8, 0xA9, 0xAA, 0xAB, 0x58, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9C, 0x9D, 0xBE, 0xBF, 0xAC, 0xAD, 0xCE, 0xCF,
    0x2E, 0x2F, 0x2E, 0x2F, 0x2E, 0x2F, 0x2E, 0x2F, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0xC9, 0xC9, 0x96, 0xB6, 0xC9, 0xC9, 0xA6, 0xC6, 0xCA, 0xCB, 0xCA, 0xEA, 0x03, 0x02, 0x03, 0x02,
    0x0D, 0x00, 0x96, 0x97, 0x0D, 0x00, 0xA6, 0xA7, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0xEC, 0x03, 0x02, 0x03, 0x6A,
    0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x70, 0x03, 0x02, 0x03, 0x80, 0x02, 0x03, 0x02, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x71, 0x03, 0x02, 0x03, 0x81, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x94, 0x95, 0x94, 0x95, 0xA4, 0xA5, 0xA4, 0xA5,
    0x70, 0x03, 0x02, 0x03, 0x80, 0x02, 0x03, 0x02, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x62, 0x01, 0x01, 0x01, 0x72, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0x00, 0x54, 0x55, 0x00, 0x00, 0x64, 0x65, 0x00, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x71, 0x03, 0x02, 0x03, 0x81, 0x62, 0x01, 0x01, 0x01, 0x72, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x62, 0x01, 0x01, 0x01, 0x72, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0x00, 0x0B, 0x0C, 0x00, 0x00, 0x1B, 0x1C, 0x00, 0x62, 0x01, 0x01, 0x01, 0x72, 0x10, 0x11, 0x10,
    0x70, 0x03, 0x02, 0x03, 0x80, 0x02, 0x03, 0x02, 0x70, 0x03, 0x02, 0x03, 0x80, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x71, 0x03, 0x02, 0x03, 0x81, 0x02, 0x03, 0x02, 0x71, 0x03, 0x02, 0x03, 0x81,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x40, 0x41, 0x11, 0x10, 0x60, 0x61,
    0xB0, 0xB1, 0xB0, 0xB1, 0xC0, 0xC1, 0xC0, 0xC1, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x21, 0x01, 0x01, 0x30, 0x31, 0x11, 0x10, 0x32, 0x02,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9,
    0x00, 0x00, 0x7B, 0x7C, 0x00, 0x04, 0x00, 0x8C, 0x00, 0x14, 0x15, 0x00, 0x82, 0x34, 0x83, 0x83,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xCA, 0xCB, 0xCA, 0xE9, 0x03, 0x02, 0x03, 0x6A,
    0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0x6A, 0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0x6A,
    0x02, 0x03, 0x02, 0x7A, 0xBB, 0xBA, 0xBB, 0xE7, 0xDC, 0xDC, 0xDC, 0xDC, 0xC9, 0xC9, 0xC9, 0xC9,
    0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0xFA, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD7, 0xD0, 0xD2, 0x00, 0xD6, 0xD1, 0xD3, 0xD4, 0xD5,
    0x00, 0x00, 0x92, 0x93, 0x00, 0x00, 0xA2, 0xA3, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x90, 0x91, 0x90, 0x91, 0xA0, 0xA1, 0xA0, 0xA1,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x62, 0x01, 0x01, 0x01, 0x72, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x01, 0x01, 0x01, 0x63, 0x11, 0x10, 0x11, 0x73,
    0x02, 0x03, 0x02, 0x03, 0xBB, 0xBA, 0xBB, 0xBA, 0xDC, 0xDC, 0xDC, 0xDC, 0xC9, 0xC9, 0xC9, 0xC9,
    0x70, 0x03, 0x02, 0x03, 0xC5, 0xBA, 0xBB, 0xBA, 0xDC, 0xDC, 0xDC, 0xDC, 0xC9, 0xC9, 0xC9, 0xC9,
    0x02, 0x03, 0x02, 0x71, 0xBB, 0xBA, 0xBB, 0xD8, 0xDC, 0xDC, 0xDC, 0xDC, 0xC9, 0xC9, 0xC9, 0xC9,
    0xDF, 0x92, 0x93, 0xC9, 0xEB, 0xE0, 0xE1, 0xDA, 0xFB, 0xCB, 0xCA, 0xEA, 0x03, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x03, 0xBB, 0xBA, 0xBB, 0xBA, 0x39, 0x3A, 0x39, 0x3A, 0x49, 0x4A, 0x49, 0x4A,
    0x59, 0x5A, 0x59, 0x5A, 0x2B, 0x2C, 0x2B, 0x2C, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9,
    0xDF, 0xC9, 0xC9, 0xC9, 0xDF, 0xC9, 0xC9, 0xC9, 0xDF, 0xC9, 0xC9, 0xC9, 0xDF, 0xC9, 0xC9, 0xC9,
    0xC3, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02, 0xC3, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x03, 0xBB, 0xBA, 0xBB, 0xDE, 0xDC, 0xDC, 0xDC, 0xEE, 0xC9, 0xC9, 0xC9, 0xC9,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0xEF, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x03, 0xDD, 0xBA, 0xBB, 0xBA, 0xED, 0xDC, 0xDC, 0xDC, 0xDF, 0xC9, 0xC9, 0xC9,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xB9, 0xC9, 0xC9, 0xC9,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xE8, 0xCB, 0xCA, 0xCB, 0xC2, 0x02, 0x03, 0x02,
    0xC3, 0x03, 0x02, 0x03, 0xE6, 0xBA, 0xBB, 0xBA, 0xC9, 0xF9, 0xDC, 0xDC, 0xC9, 0xC9, 0xC9, 0xC9,
    0xDF, 0xC9, 0xC9, 0xC9, 0xDF, 0xC9, 0xC9, 0xC9, 0xF8, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9,
    0xDF, 0xC9, 0xC9, 0xC9, 0xEB, 0xC9, 0xC9, 0xC9, 0xFB, 0xCB, 0xCA, 0xCB, 0x03, 0x02, 0x03, 0x02,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xCA, 0xCB, 0xCA, 0xCB, 0x03, 0x02, 0x03, 0x02,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC4, 0xCB, 0xCA, 0xCB, 0x80, 0x02, 0x03, 0x02,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xCA, 0xCB, 0xCA, 0xD9, 0x03, 0x02, 0x03, 0x81,
    0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xDA, 0xCA, 0xCB, 0xCA, 0xEA, 0x03, 0x02, 0x03, 0x02,
    0xC3, 0x03, 0x02, 0x03, 0xDB, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x74, 0x11, 0x10, 0x11, 0x84,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x75, 0x01, 0x01, 0x01, 0x85, 0x10, 0x11, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xE3, 0xE4, 0x00, 0x00, 0xF3, 0xF4, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x70, 0x03, 0x02, 0x03, 0x76, 0x77, 0x78, 0x77, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x71, 0x78, 0x77, 0x78, 0x79, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x03, 0x78, 0x77, 0x78, 0x77, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x70, 0x03, 0x02, 0x03, 0x7F, 0x77, 0x78, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x02, 0x03, 0x02, 0x71, 0x78, 0x77, 0x78, 0x8F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x02, 0x03, 0x02, 0x03, 0x78, 0x77, 0x78, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x40, 0x41, 0x00, 0x00, 0x50, 0x51, 0x01, 0x01, 0x03, 0x42, 0x11, 0x10,
    0x02, 0x03, 0x8A, 0x8B, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x48, 0x32, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x33, 0x23, 0x40, 0x41, 0x03, 0x33, 0x60, 0x61, 0x02, 0x03, 0x02, 0x43, 0x03, 0x02, 0x03, 0x02,
    0x20, 0x21, 0x22, 0x32, 0x52, 0x53, 0x32, 0x02, 0x2D, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFC, 0xFD, 0x00, 0x00, 0xFE, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFD, 0x00, 0x00, 0xFE, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFC, 0xFD, 0xFC, 0xFD, 0xFE, 0xFF, 0xFE, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x03, 0xBB, 0xBA, 0xBB, 0xBA, 0xDC, 0xDC, 0xDC, 0xDC, 0xC9, 0xC9, 0xC9, 0xC9,
    0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0x6A, 0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0x6A,
    0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0x6A, 0x02, 0x03, 0x02, 0x7A, 0x03, 0x02, 0x03, 0x6A,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0xC3, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02, 0xC3, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02,
    0xC3, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02, 0xC3, 0x03, 0x02, 0x03, 0xC2, 0x02, 0x03, 0x02,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0xE5, 0xE5, 0xE5, 0xE5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5,
    0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5,
    0xF5, 0xF5, 0xF5, 0xF5, 0x86, 0xF5, 0xF5, 0xF5, 0xFB, 0xCB, 0xCA, 0xCB, 0x03, 0x02, 0x03, 0x02,
    0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0x87, 0xCA, 0xCB, 0xCA, 0xEA, 0x03, 0x02, 0x03, 0x02,
    0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xCA, 0xCB, 0xCA, 0xF6, 0x03, 0x02, 0x03, 0x6A,
    0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF7, 0xCB, 0xCA, 0xCB, 0xC2, 0x02, 0x03, 0x02,
    0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xCA, 0xCB, 0xCA, 0xCB, 0x03, 0x02, 0x03, 0x02,
    0xE5, 0xE5, 0xE5, 0xE5, 0x86, 0xF5, 0xF5, 0xF5, 0xFB, 0xCB, 0xCA, 0xCB, 0x03, 0x02, 0x03, 0x02,
    0xE5, 0xE5, 0xE5, 0xE5, 0xF5, 0xF5, 0xF5, 0x87, 0xCA, 0xCB, 0xCA, 0xEA, 0x03, 0x02, 0x03, 0x02,
    0xE5, 0xE5, 0xE5, 0xE5, 0xF5, 0xF5, 0xF5, 0xF5, 0xCA, 0xCB, 0xCA, 0xF6, 0x03, 0x02, 0x03, 0x6A,
    0xE5, 0xE5, 0xE5, 0xE5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF7, 0xCB, 0xCA, 0xCB, 0xC2, 0x02, 0x03, 0x02,
    0xE5, 0xE5, 0xE5, 0xE5, 0xF5, 0xF5, 0xF5, 0xF5, 0xCA, 0xCB, 0xCA, 0xCB, 0x03, 0x02, 0x03, 0x02,
    0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8,
    0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0x88, 0x88, 0x88, 0x88,
    0xE5, 0xE5, 0xE5, 0xE5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0x89, 0x89, 0x89, 0x89,
    0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0x89, 0xF5, 0x89, 0x89, 0xB8, 0x89, 0xB8,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x3C, 0x00, 0x00, 0x4B, 0x4C, 0x00, 0x00, 0x5B, 0x5C,
    0x00, 0x00, 0x00, 0x00, 0x3D, 0x3E, 0x3F, 0x00, 0x4D, 0x4E, 0x4F, 0x00, 0x5D, 0x5E, 0x5F, 0x00,
    0x00, 0x00, 0x6B, 0x6C, 0x00, 0x00, 0x7B, 0x7C, 0x00, 0x00, 0x00, 0x8C, 0x00, 0x00, 0x00, 0x00,
    0x6D, 0x6E, 0x6F, 0x00, 0x7D, 0x7E, 0x00, 0x00, 0x8D, 0x8E, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00,
    0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00,
    0x0D, 0x00, 0x0B, 0x0C, 0x0D, 0x00, 0x1B, 0x1C, 0x01, 0x01, 0x01, 0x01, 0x11, 0x10, 0x11, 0x10,
    0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    # fmt: on
]


layout_fname_extn_widths = {
    ".layout8": (1 << 8),
    ".layout7": (1 << 7),
    ".layout6": (1 << 6),
    ".layout5": (1 << 5),
    ".layout4": (1 << 4),
}


class TkApp:
    tm_width = 32
    tm_height = 28

    def __init__(self) -> None:
        self.level_width = 0x40
        self.level_height = 0x1000 // self.level_width
        assert self.level_width * self.level_height == 0x1000

        self.tk = tkinter.Tk(className="level_viewer")
        self.tk.wm_title("Sonic 1 SMS Level Viewer")

        self.vram = bytearray(0x4000)
        self.cram = bytearray(0x20)
        self.layout = bytearray(0x1000)
        self.object_defs: list[tuple[int, int, int]] = []

        self.cam_mtx = 0
        self.cam_mty = 9

        # TEST: Pre-set tileset to a cycle
        for i in range(self.tm_width * self.tm_height):
            v = i

            # Skip over tilemap and sprite attribute table
            if v >= (0x3800 >> 5):
                v += 0x0800 >> 5

            # v = (v + 0x200) & ~0x600  # force vflip
            v = (v + 0x600) & ~0x600  # force second palette
            self.vram[0x3800 + (i * 2) + 0] = v & 0xFF
            self.vram[0x3800 + (i * 2) + 1] = v >> 8

        # One variant for each:
        # +1 = hflip
        # +2 = vflip
        # +4 = palette index
        self.vram_tile_images: MutableSequence[Optional[tkinter.PhotoImage]] = [
            None for i in range(512 * 8)
        ]
        self.vram_tilemap_widgets: MutableSequence[Optional[tkinter.ttk.Label]] = [
            None
        ] * (self.tm_width * self.tm_height)

    def add_file(self, *, file_path: pathlib.Path) -> None:
        if False:
            logging.debug(
                "Determining file type %(file_path)r", {"file_path": str(file_path)}
            )

        if file_path.suffix in {".art0000", ".art2000", ".art3000"}:
            self.load_art_file(
                file_path=file_path,
                vram_addr=int(file_path.suffix[len(".art") :], 16),
            )

        elif file_path.suffix in {".pal1", ".pal2", ".pal3", ".pal1c"}:
            self.load_palette(
                file_path=file_path,
                has_p0=(file_path.suffix not in {".pal2"}),
                has_p1=(file_path.suffix not in {".pal1", ".pal1c"}),
                is_cycling=(file_path.suffix in {".pal1c"}),
            )

        elif file_path.suffix in {".sonicuncart"}:
            self.load_3bpp_art(
                file_path=file_path,
                vram_addr=0x3680,
            )

        elif file_path.suffix in layout_fname_extn_widths:
            self.load_layout(
                file_path=file_path,
                level_width=layout_fname_extn_widths[file_path.suffix],
            )

        else:
            logging.warning(
                "Could not determine type of file %(file_path)r",
                {"file_path": str(file_path)},
            )

    def load_art_file(self, *, file_path: pathlib.Path, vram_addr: int) -> None:
        assert 0x0000 <= vram_addr <= 0x3FFF
        logging.info(
            "Loading art into VRAM $%(vram_addr)04X from %(file_path)r",
            {"file_path": str(file_path), "vram_addr": vram_addr},
        )

        art = file_path.open("rb").read()
        magic, offsets_ptr, rows_ptr, row_count = struct.unpack("<HHHH", art[:8])
        assert magic == 0x5948, '"HY" signature missing from compressed art file'
        bitmask_ptr = 8
        assert row_count % 8 == 0, "non-multiple-of-8 tile count"
        assert (
            bitmask_ptr < offsets_ptr < rows_ptr
        ), "weirdly-ordered art file or not a real art file"
        assert offsets_ptr == bitmask_ptr + (row_count // 8), "gap after bit mask"
        bitmask = art[bitmask_ptr:offsets_ptr]
        offsets = art[offsets_ptr:rows_ptr]
        rows = art[rows_ptr:]
        oi = 0  # Offset index (in bytes)
        ri = 0  # Row index (in bytes)
        vi = vram_addr  # VRAM index (in bytes)
        for b in bitmask:
            for i in range(8):
                if (b & (1 << i)) == 0:
                    # Literal tile
                    use_ri = ri
                    ri += 4
                else:
                    # Offset
                    use_ri = offsets[oi]
                    oi += 1
                    if use_ri >= 0xF0:
                        # This is a long offset
                        use_ri = ((use_ri - 0xF0) << 8) + offsets[oi]
                        oi += 1
                    use_ri *= 4
                self.vram[vi : vi + 4] = rows[use_ri : use_ri + 4]
                vi += 4

        assert oi == len(offsets), "extra junk after offsets"
        assert ri == len(rows), "extra junk after rows"

    def load_palette(
        self, *, file_path: pathlib.Path, has_p0: bool, has_p1: bool, is_cycling: bool
    ) -> None:
        palette_idx_list: list[int] = []
        if has_p0:
            palette_idx_list.append(0)
        if has_p1:
            palette_idx_list.append(1)
        logging.info(
            "Loading palette from %(file_path)r, palettes %(palette_idx_list)r, cycling=%(cycling_str)s",
            {
                "file_path": str(file_path),
                "palette_idx_list": palette_idx_list,
                "cycling_str": str(int(is_cycling)),
            },
        )
        assert has_p0 or has_p1
        assert (not is_cycling) or (has_p0 and not has_p1)

        # TODO: Handle cycling palettes properly! --GM
        with file_path.open("rb") as infp:
            for pi in palette_idx_list:
                self.cram[pi * 0x10 : (pi + 1) * 0x10] = infp.read(16)

    def load_3bpp_art(self, *, file_path: pathlib.Path, vram_addr: int) -> None:
        assert 0x0000 <= vram_addr <= 0x3FFF
        logging.info(
            "Loading uncompressed 3bpp Sonic art into VRAM $%(vram_addr)04X from %(file_path)r",
            {"file_path": str(file_path), "vram_addr": vram_addr},
        )
        data = file_path.open("rb").read()
        assert len(data) == 288
        for i in range(288 // 3):
            self.vram[vram_addr + (i * 4) : vram_addr + (i * 4) + 4] = data[
                i * 3 : (i + 1) * 3
            ] + bytes([0])

    def load_layout(self, *, file_path: pathlib.Path, level_width: int) -> None:
        logging.info(
            "Loading level layout from %(file_path)r",
            {"file_path": str(file_path)},
        )

        self.level_width = level_width
        self.level_height = 0x1000 // self.level_width
        assert self.level_width * self.level_height == 0x1000

        prev_literal = -1
        self.layout = bytearray(0x1000)
        out_idx = 0
        with file_path.open("rb") as infp:
            while True:
                bs = infp.read(1)
                if bs == b"":
                    break
                v = bs[0]
                if v != prev_literal:
                    self.layout[out_idx] = v
                    out_idx += 1
                    prev_literal = v
                else:
                    repeats = infp.read(1)[0]
                    # EDGE CASE: 8-bit wraparound.
                    # Unlike ZZT, this case actually gets used!
                    if repeats == 0x00:
                        repeats = 0x100
                    for i in range(repeats):
                        self.layout[out_idx] = v
                        out_idx += 1
                    prev_literal = -1

        logging.debug(f"Layout ended at $%(end_offs)04X", {"end_offs": out_idx})

    def run(self) -> None:
        # Redraw everything
        self.redraw()

        # Bind buttons for scrolling
        self.tk.bind("<Key-Up>", lambda ev: self.scroll_by(0, -1))
        self.tk.bind("<Key-Down>", lambda ev: self.scroll_by(0, +1))
        self.tk.bind("<Key-Left>", lambda ev: self.scroll_by(-1, 0))
        self.tk.bind("<Key-Right>", lambda ev: self.scroll_by(+1, 0))

        # Run the main loop!
        self.tk.mainloop()

    def scroll_by(self, dx: int, dy: int) -> None:
        ox, oy = self.cam_mtx, self.cam_mty
        self.cam_mtx = max(0, min(self.level_width - (self.tm_width // 4), ox + dx))
        self.cam_mty = max(0, min(self.level_height - (self.tm_height // 4), oy + dy))
        if (ox, oy) != (self.cam_mtx, self.cam_mty):
            self.redraw()

    def redraw(self) -> None:
        # Set up layout
        for cy in range(self.tm_height // 4):
            for cx in range(self.tm_width // 4):
                # Metatile index
                mtidx = self.layout[
                    ((cy + self.cam_mty) * self.level_width) + cx + self.cam_mtx
                ]
                hi = (hi_bytes[mtidx] >> 3) & 0x10
                for ty in range(4):
                    for tx in range(4):
                        vidx = (cx * 4 + tx) + (self.tm_width * (cy * 4 + ty))
                        lo = lo_bytes[tx + (4 * (ty + (4 * mtidx)))]
                        self.vram[0x3800 + (vidx * 2) + 0] = lo
                        self.vram[0x3800 + (vidx * 2) + 1] = hi

        # Draw a 32x28 display
        for ty in range(self.tm_height):
            for tx in range(self.tm_width):
                tmi = tx + (self.tm_width * ty)
                (tdata,) = struct.unpack(
                    "<H", self.vram[0x3800 + (tmi * 2) : 0x3800 + (tmi * 2) + 2]
                )
                tdata &= 0xFFF

                if self.vram_tile_images[tdata] is None:
                    tm_img = tkinter.PhotoImage(width=8 * 2, height=8 * 2)
                    self.vram_tile_images[tdata] = tm_img

                    # Draw image
                    outdata: list[list[int]] = []
                    toffs = (tdata & 0x1FF) * 4 * 8
                    xflip = 0x0 if (tdata & 0x200) != 0 else 0x7
                    yflip = 0x7 if (tdata & 0x400) != 0 else 0x0
                    palsel = (tdata >> 11) & 0x1
                    cram = self.cram[palsel * 16 : (palsel + 1) * 16]
                    for y in range(8):
                        outdata.append([])
                        planes = self.vram[
                            toffs + (4 * (yflip ^ y)) : toffs + (4 * ((yflip ^ y) + 1))
                        ]
                        for x in range(8):
                            p = 0
                            p |= ((planes[0] >> (xflip ^ x)) << 0) & (1 << 0)
                            p |= ((planes[1] >> (xflip ^ x)) << 1) & (1 << 1)
                            p |= ((planes[2] >> (xflip ^ x)) << 2) & (1 << 2)
                            p |= ((planes[3] >> (xflip ^ x)) << 3) & (1 << 3)
                            palv = cram[p]
                            c = 0
                            c |= (((palv >> 0) & 0x3) * 0x55) << 16
                            c |= (((palv >> 2) & 0x3) * 0x55) << 8
                            c |= (((palv >> 4) & 0x3) * 0x55) << 0
                            outdata[-1].append(c)
                            outdata[-1].append(c)
                        outdata.append(outdata[-1])
                    outstr = " ".join(
                        "{" + " ".join(f"#{v:06X}" for v in row) + "}"
                        for row in outdata
                    )
                    tm_img.put(outstr)
                else:
                    tm_img = self.vram_tile_images[tdata]

                opt_tm_lbl = self.vram_tilemap_widgets[tmi]
                if opt_tm_lbl is None:
                    tm_lbl = tkinter.ttk.Label(border=0)
                    tm_lbl.grid(column=tx, row=ty)
                    self.vram_tilemap_widgets[tmi] = tm_lbl
                else:
                    tm_lbl = opt_tm_lbl
                tm_lbl.configure(image=tm_img)


if __name__ == "__main__":
    main()
